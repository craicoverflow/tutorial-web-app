= SOAP to REST

Contract-first API development wrapping an existing SOAP service, implemented using Eclipse Che

* Audience: Developers and Architects

Another important use case in developing API's is to take an existing
legacy SOAP service and wrap it with a new RESTful endpoint. This SOAP
to REST transformation is implemented in the API service layer (Fuse).
This lab will walk you through taking an existing SOAP contract (WSDL),
converting it to Java POJO's and exposing it using Camel RESTdsl.

Eclipse Che, our online IDE, provides important functionality for
implementing API services. In this lab you can see how our Eclipse Che
and Fuse can help with SOAP to REST transformation on OpenShift.

== Add REST Routes to the soap2rest App

=== Enable the Codegen plugin in the soap2rest App

. Log in to the link:{che-url}[Che, window="_blank"] Dashboard.

. TODO steps to setup a workspace and import the soap2rest project from gogs

. Open the `dayinthelife-import/location-soap2rest` project. Open the `pom.xml` file and scroll to the bottom. Uncomment out the `cxf-codegen-plugin` entry at the bottom. Update the `<wsdl>` entry with your fully qualified WSDL 
URL e.g.
`http://location-soap-simon-dev.apps.52d6.openshift.opentlc.com/ws/location?wsdl`.

. TODO link for actual wsdl

[verification=true]
The wsdl file is served successfully.

=== Generate POJOs from the WSDL contract

// image:/walkthroughs/soap-to-rest/images/00-uncomment-codegen.png[00-uncomment-codegen.png,title="Uncomment codegen plugin"]
. We now need to generate the POJO objects from the WSDL contract. To
do this, change to the *Manage commands* view and double-click the
`run generate-sources` script. Click *Run* to execute the script.

// image:/walkthroughs/soap-to-rest/images/00-generate-sources.png[00-generate-sources.png,title="Generate Sources"]

[verification=true]
Once the script has completed, navigate back to the *Workspace* view
and open the `src/main/java/com/redhat` folder. Notice that there are a
bunch of new POJO classes that were created by the Maven script.

=== Add REST routes to the soap2rest App

// image:/walkthroughs/soap-to-rest/images/00-verify-pojos.png[00-verify-pojos.png,title="Verify Pojos"]

. Open up the `CamelRoutes.java` file. Notice that the existing
implementation is barebones. First of all, we need to enter the SOAP
service address and WSDL location for our CXF client to call.

. Secondly,we need to create our Camel route implementation and create the RESTful
endpoint. To do this, include the following code (making sure to update
the GUID and username values in the `to("cxf://` URL):
+
[source,java]
----

...

@Autowired
private CamelContext camelContext;

private static final String SERVICE_ADDRESS = "http://localhost:8080/ws/location";
private static final String WSDL_URL = "http://localhost:8080/ws/location?wsdl";

@Override
public void configure() throws Exception {

... 

    rest("/location").description("Location information")
        .produces("application/json")
        .get("/contact/{id}").description("Location Contact Info")
            .responseMessage().code(200).message("Data successfully returned").endResponseMessage()
            .to("direct:getalllocationphone")

    ;

    from("direct:getalllocationphone")
        .setBody().simple("${headers.id}")
        .unmarshal().json(JsonLibrary.Jackson)
        .to("cxf://http://location-soap-userX.apps.GUID.openshiftworkshop.com/ws/location?serviceClass=com.redhat.LocationDetailServicePortType&defaultOperationName=contact")

        .process(
                new Processor(){

                    @Override
                    public void process(Exchange exchange) throws Exception {
                        //LocationDetail locationDetail = new LocationDetail();
                        //locationDetail.setId(Integer.valueOf((String)exchange.getIn().getHeader("id")));

                        MessageContentsList list = (MessageContentsList)exchange.getIn().getBody();

                        exchange.getOut().setBody((ContactInfo)list.get(0));
                    }
                }
        )

    ;

    }
}
----

. Now that we have our API service implementation, we can try to test
this 'locally' in Che. Navigate back to the *Manage commands* view and execute
the `run spring-boot` script. Click the *Run* button.
//image:/walkthroughs/soap-to-rest/images/00-local-testing.png[00-local-testing.png]
. Once the application starts, navigate to the Servers window and
click on the URL corresponding to port 8080. A new tab should appear:
//image:/walkthroughs/soap-to-rest/images/00-select-servers.png[00-select-servers.png]
. In the new tab, append the URL with the following URI: `/location/contact/2`.

[verification=true]
A contact should be returned from the endpoint.

== Try out the soap2rest App UI

=== Deploy the soap2rest App to OpenShift

image:/walkthroughs/soap-to-rest/images/00-hit-contact-local.png[00-hit-contact-local.png]
Now that we've successfully tested our new SOAP to REST service
locally, we can deploy it to OpenShift. Stop the running application by
clicking *Cancel*. Open the terminal and login using the `oc login`
command and select your corresponding OCPPROJECT e.g.
`oc project OCPPROJECT`. Open the `fabic8:deploy` script and hit the
*Run* button to deploy it to OpenShift.
+
image:/walkthroughs/soap-to-rest/images/00-mvn-f8-deploy.png[00-mvn-f8-deploy.png,title="Maven Fabric8 Deploy"]
If the deployment script completes successfully, navigate back to
your OCPPROJECT web console and verify the pod is running

[verification=true]
Check that thing.

=== Try out the REST routes in the UI

TODO: UI

[verification=true]
Check that thing.